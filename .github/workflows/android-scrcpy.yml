name: Android Emulator - Cloudflare Tunnel (No Signup)
on:
  workflow_dispatch:  # Manual start from Actions tab
  schedule:
    - cron: '0 */5 * * *'  # Auto-restart every 5 hours

jobs:
  android-emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      # Enable KVM for hardware acceleration
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo apt-get install -y libpulse0 libgl1-mesa-glx
      
      # Install Cloudflare Tunnel (No signup needed!)
      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          cloudflared version
      
      # Start Android Emulator (with root access)
      - name: Start Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          arch: x86_64
          target: default
          profile: Nexus 6
          cores: 2
          ram-size: 4096M
          heap-size: 512M
          sdcard-path-or-size: 1024M
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: false
          script: |
            echo "================================================"
            echo "ðŸš€ Starting Android Emulator with ROOT access"
            echo "================================================"
            
            # Wait for emulator to boot completely
            adb wait-for-device
            echo "âœ… Emulator device detected"
            
            # Enable root access
            adb root
            sleep 3
            adb wait-for-device
            echo "âœ… Root access enabled"
            
            # Verify root
            adb shell "whoami"
            
            # Enable TCP/IP mode on port 5555
            adb tcpip 5555
            sleep 3
            echo "âœ… ADB TCP/IP enabled on port 5555"
            
            # Start Cloudflare Tunnel in background (NO SIGNUP REQUIRED!)
            echo "================================================"
            echo "ðŸŒ Starting Cloudflare Tunnel..."
            echo "================================================"
            cloudflared tunnel --url tcp://localhost:5555 > cloudflare.log 2>&1 &
            TUNNEL_PID=$!
            
            # Wait for tunnel to initialize
            sleep 15
            
            # Extract the public URL
            TUNNEL_URL=$(grep -oP 'https://.*?.trycloudflare.com' cloudflare.log | head -1)
            
            if [ -z "$TUNNEL_URL" ]; then
              echo "âš ï¸  Waiting longer for tunnel..."
              sleep 10
              TUNNEL_URL=$(grep -oP 'https://.*?.trycloudflare.com' cloudflare.log | head -1)
            fi
            
            # Display connection info
            echo ""
            echo "================================================"
            echo "âœ… âœ… âœ… ANDROID EMULATOR READY! âœ… âœ… âœ…"
            echo "================================================"
            echo ""
            echo "ðŸ“± Android Version: 10 (API 29)"
            echo "ðŸ”“ Root Access: ENABLED"
            echo "ðŸ’¾ RAM: 4GB"
            echo "âš¡ Hardware Acceleration: KVM Enabled"
            echo ""
            echo "ðŸŒ Cloudflare Tunnel URL:"
            echo "$TUNNEL_URL"
            echo ""
            echo "================================================"
            echo "ðŸ“‹ CONNECTION INSTRUCTIONS:"
            echo "================================================"
            echo ""
            echo "1. Install scrcpy on your PC:"
            echo "   - Windows: Download from https://github.com/Genymobile/scrcpy/releases"
            echo "   - Linux: sudo apt install scrcpy"
            echo "   - macOS: brew install scrcpy"
            echo ""
            echo "2. Extract HOST and PORT from URL above"
            echo "   Example: https://abc-123.trycloudflare.com"
            echo "   HOST: abc-123.trycloudflare.com"
            echo "   PORT: 443"
            echo ""
            echo "3. Connect with:"
            HOST=$(echo $TUNNEL_URL | sed 's|https://||' | sed 's|/.*||')
            echo "   scrcpy --tcpip=$HOST:443"
            echo ""
            echo "   OR for better performance over internet:"
            echo "   scrcpy --tcpip=$HOST:443 -b2M -m1024 --max-fps=30"
            echo ""
            echo "================================================"
            echo "ðŸŽ® INSTALL YOUR APPS:"
            echo "================================================"
            echo ""
            echo "Option 1 - Drag & drop APK into scrcpy window"
            echo "Option 2 - Add APKs to repo and uncomment below:"
            echo ""
            # Uncomment these lines after adding APKs to your repo
            # adb install -r apps/gameguardian.apk
            # adb install -r apps/yourgame.apk
            # echo "âœ… Apps installed!"
            echo ""
            echo "================================================"
            
            # Show tunnel logs
            echo ""
            echo "Cloudflare Tunnel Logs:"
            cat cloudflare.log
            echo ""
            echo "================================================"
            echo "â³ Keeping emulator alive for 6 hours..."
            echo "================================================"
            
            # Keep emulator running for 6 hours
            START_TIME=$(date +%s)
            COUNTER=0
            
            while true; do
              CURRENT_TIME=$(date +%s)
              ELAPSED=$((CURRENT_TIME - START_TIME))
              REMAINING=$((21600 - ELAPSED))
              
              # Check every 60 seconds
              if [ $((COUNTER % 60)) -eq 0 ]; then
                HOURS=$((REMAINING / 3600))
                MINUTES=$(((REMAINING % 3600) / 60))
                echo "â° Time remaining: ${HOURS}h ${MINUTES}m | Tunnel: Active | ADB: $(adb get-state 2>/dev/null || echo 'checking...')"
              fi
              
              # Exit if 6 hours elapsed
              if [ $ELAPSED -ge 21600 ]; then
                echo "â° 6 hours completed. Workflow will restart automatically."
                break
              fi
              
              # Keep connection alive
              adb shell "date" > /dev/null 2>&1
              
              sleep 1
              COUNTER=$((COUNTER + 1))
            done
            
            echo "âœ… Session ended. Check Actions tab for next automatic run."
