name: avd-cache

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Session duration in minutes (1â€“360)'
        required: false
        default: '5'

jobs:
  run-emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable KVM (hardware accel)
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Set up JDK 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /opt/hostedtoolcache/CodeQL /usr/local/share/boost
          sudo docker image prune -a -f || true
          sudo apt-get clean
          df -h

      - name: Install FRP client v0.58.1
        run: |
          wget -q https://github.com/fatedier/frp/releases/download/v0.58.1/frp_0.58.1_linux_amd64.tar.gz
          tar -xzf frp_0.58.1_linux_amd64.tar.gz
          sudo install -m 0755 frp_0.58.1_linux_amd64/frpc /usr/local/bin/frpc
          rm -rf frp_0.58.1_linux_amd64*

      - name: Configure FRP (KCP) and start
        shell: bash
        run: |
          cat <<EOF > frpc.toml
          serverAddr = "159.195.6.61"
          serverPort = 7000
          transport.protocol = "kcp"

          [[proxies]]
          name = "github-avd-adb"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5555
          remotePort = 5555

          [[proxies]]
          name = "github-avd-console"
          type = "tcp"
          localIP = "127.0.0.1"
          localPort = 5554
          remotePort = 5554
          EOF

          nohup frpc -c frpc.toml > frpc.log 2>&1 &
          for i in {1..5}; do
            pgrep -x frpc && break
            sleep 1
          done

          if pgrep -x frpc >/dev/null; then
            echo "frpc running"
          else
            echo "frpc failed"
            exit 1
          fi

      - name: Restore persistent AVD cache
        uses: actions/cache/restore@v4
        id: avd-cache
        continue-on-error: true
        with:
          path: |
            ~/.android/avd
            ~/.android/adb*
          key: avd-30-persistent-v1
          restore-keys: |
            avd-30-persistent-v1

      - name: Create timer.sh
        shell: bash
        run: |
          cat <<'EOF' > timer.sh
          #!/usr/bin/env bash
          set -euo pipefail
          MIN="${1:-5}"
          [[ "$MIN" =~ ^[0-9]+$ ]] || MIN=5
          (( MIN<1 )) && MIN=1
          (( MIN>360 )) && MIN=360
          TOTAL=$(( MIN*60 ))
          for ((s=0;s<TOTAL;s++)); do
            if (( s % 10 == 0 )); then
              DEV=$(adb devices | awk '/5555.*device/{c++} END{print c+0}' || echo 0)
              pgrep -x frpc >/dev/null && ST=OK || ST=DOWN
              echo "[timer] ${s}/${TOTAL}s | adb:${DEV} | frp:${ST}"
            fi
            sleep 1
          done
          echo "[timer] done"
          EOF
          chmod +x timer.sh

      - name: Create session.sh
        shell: bash
        run: |
          cat <<'EOF' > session.sh
          #!/usr/bin/env bash
          set -euo pipefail
          DUR="${1:-5}"
          [[ "$DUR" =~ ^[0-9]+$ ]] || DUR=5
          (( DUR<1 )) && DUR=1
          (( DUR>360 )) && DUR=360

          adb kill-server || true
          adb wait-for-device
          adb root || true
          adb wait-for-device
          adb remount || true
          adb tcpip 5555 || true
          sleep 2
          adb connect 127.0.0.1:5555 || true
          sleep 1
          echo "[session] adb devices:"; adb devices

          echo -n "Android: "; adb shell getprop ro.build.version.release || true
          echo -n "ABIs:    "; adb shell getprop ro.product.cpu.abilist || true
          echo -n "Model:   "; adb shell getprop ro.product.model || true
          adb shell 'grep -m1 MemTotal /proc/meminfo' || true
          adb shell 'df -h /data | tail -n +2' || true
          echo -n "whoami:  "; adb shell whoami 2>/dev/null | tr -d '\n' || true
          echo -n "packages:"; adb shell 'pm list packages 2>/dev/null | wc -l' || true

          echo "[session] tunnel: 159.195.6.61:5555 (FRP KCP)"
          ./timer.sh "$DUR"
          echo "[session] finished"
          EOF
          chmod +x session.sh

      - name: Start rooted Android 11 emulator (persistent)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: pixel6pro
          avd-name: test
          ram-size: 6144M
          heap-size: 1024M
          disk-size: 12288M
          force-avd-creation: false
          emulator-boot-timeout: 600
          disable-animations: true
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none -writable-system
          script: ./session.sh "${{ inputs.duration }}"

      - name: Save persistent AVD cache (always)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.android/avd
            ~/.android/adb*
          key: avd-30-persistent-v1

      - name: Upload FRP logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frp-logs
          path: |
            frpc.log
            frpc.toml
          retention-days: 7
