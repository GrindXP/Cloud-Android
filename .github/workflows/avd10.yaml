name: Boot Rooted Android 10 AVD + Remote Access

on: [push, pull_request, workflow_dispatch]

jobs:
  rooted-avd:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: android-actions/setup-android@v3
    
    # Step 1: Install gdown
    - name: Install gdown
      run: |
        pip install gdown --upgrade
        echo "✅ gdown installed"
    
    # Step 2: Download Config Files
    - name: Download Config Files
      run: |
        echo "⏳ Downloading config files..."
        
        gdown "https://drive.google.com/uc?id=1njW8dKWUC90p6edEgxkXaMXfx6Xu0pU2" \
          -O ~/config-files.zip \
          --quiet
        
        mkdir -p ~/.android/avd/pixel_4.avd
        unzip -q ~/config-files.zip -d ~/.android/avd/pixel_4.avd/
        
        echo "✅ Config files extracted"
    
    # Step 3: Download Rooted Userdata
    - name: Download Rooted Userdata
      run: |
        echo "⏳ Downloading rooted userdata (may take 10 minutes)..."
        
        gdown "https://drive.google.com/uc?id=1f1gJ00aLuxefIT7VHkEG8mWsFio32K_O" \
          -O ~/.android/avd/pixel_4.avd/userdata-qemu.img \
          --quiet
        
        echo "✅ Userdata downloaded"
    
    # Step 4: Setup SDK
    - name: Setup Android SDK
      run: |
        echo "⏳ Accepting licenses..."
        yes | sdkmanager --licenses > /dev/null 2>&1
        
        echo "⏳ Downloading system image..."
        sdkmanager "system-images;android-30;google_apis;x86_64"
        
        echo "✅ Android SDK ready"
    
    # Step 5: CRITICAL - Download & Install Emulator
    - name: Download & Install Emulator
      run: |
        echo "⏳ Installing emulator package..."
        sdkmanager "emulator"
        
        echo "⏳ Setting up emulator PATH..."
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$ANDROID_SDK_ROOT/emulator:$ANDROID_SDK_ROOT/platform-tools:$PATH
        
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "$ANDROID_SDK_ROOT/emulator" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
        
        echo "✅ Emulator installed"
        
        # Verify
        which emulator
        emulator -version
    
    # Step 6: Boot Emulator
    - name: Boot Rooted Android 10 AVD
      run: |
        echo "⏳ Setting environment..."
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$ANDROID_SDK_ROOT/emulator:$ANDROID_SDK_ROOT/platform-tools:$PATH
        
        echo "⏳ Booting emulator..."
        timeout 120 emulator -avd pixel_4 \
          -no-snapshot-save \
          -no-window \
          -gpu off \
          -verbose &
        
        echo "⏳ Waiting for adb daemon..."
        sleep 10
        
        echo "⏳ Connecting to device..."
        adb wait-for-device
        
        echo "⏳ Booting system (this may take 2-3 minutes)..."
        for i in {1..60}; do
          if adb shell getprop sys.boot_completed | grep -q 1; then
            echo "✅ Boot completed!"
            break
          fi
          echo "Wait $i/60..."
          sleep 3
        done
        
        echo "⏳ Enabling ADB TCP..."
        adb tcpip 5555
        
        echo "✅ Emulator ready"
        adb devices
    
    # Step 7: Test Root
    - name: Test Root Access
      run: |
        echo "🔍 Testing root access..."
        
        sleep 10
        
        # Test root
        adb shell su -c "whoami" || adb shell su -c "id"
        
        echo "✅ Root access verified"
    
    # Step 8: Display Access Info
    - name: Display Remote Access Info
      run: |
        RUNNER_IP=$(curl -s https://api.ipify.org 2>/dev/null || echo "159.195.6.61")
        
        echo ""
        echo "════════════════════════════════════════════════════════════════"
        echo "✅ ROOTED ANDROID 10 AVD READY FOR REMOTE ACCESS"
        echo "════════════════════════════════════════════════════════════════"
        echo ""
        echo "🎯 REMOTE CONNECTION COMMANDS:"
        echo ""
        echo "1. ADB (Android Terminal Access):"
        echo "   adb connect 159.195.6.61:5555"
        echo "   adb shell su -c 'whoami'   # Should output: root"
        echo ""
        echo "2. VNC (Desktop GUI):"
        echo "   vncviewer 159.195.6.61:5900"
        echo ""
        echo "════════════════════════════════════════════════════════════════"
        echo ""
    
    # Step 9: Keep Running
    - name: Keep Emulator Running
      run: |
        echo "⏳ Emulator running for remote access..."
        echo "Keep this workflow running to maintain ADB connection"
        echo ""
        
        sleep 2700  # Keep for 45 minutes
    
    # Cleanup
    - name: Cleanup
      if: always()
      run: |
        adb emu kill || true
        pkill -f emulator || true
        echo "✅ Cleanup done"
