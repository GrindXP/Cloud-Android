name: Android Cloud with FRP

on:
  workflow_dispatch:

jobs:
  android-cloud:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v3

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Download and configure FRP client
        run: |
          wget https://github.com/fatedier/frp/releases/download/v0.58.1/frp_0.58.1_linux_amd64.tar.gz
          tar -xvzf frp_0.58.1_linux_amd64.tar.gz
          cd frp_0.58.1_linux_amd64
          cat > frpc.ini << EOF
[common]
server_addr = 159.195.6.61
server_port = 7000

[adb-tcp]
type = tcp
local_ip = 127.0.0.1
local_port = 5555
remote_port = 5555
EOF

          nohup ./frpc -c frpc.ini &
          cd ..

      - name: Launch Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          arch: x86_64
          profile: Nexus 6
          ram-size: 4096M
          cores: 2
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: |
            echo "Waiting for emulator..."
            adb wait-for-device
            adb root
            sleep 3
            adb tcpip 5555
            sleep 10
            echo "FRP tunnel should now be forwarding 5555 to your VPS!"
            # Keep action alive for manual interaction
            while true; do sleep 60; done
