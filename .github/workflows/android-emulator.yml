name: Android Emulator - Cloudflare Tunnel
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

jobs:
  android-emulator:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo apt-get install -y libpulse0 libgl1-mesa-glx
      
      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
      
      - name: Start Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          arch: x86_64
          profile: Nexus 6
          cores: 2
          ram-size: 4096M
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          script: |
            adb wait-for-device
            adb root
            sleep 3
            adb tcpip 5555
            sleep 3
            
            cloudflared tunnel --url tcp://localhost:5555 > cloudflare.log 2>&1 &
            sleep 15
            
            TUNNEL_URL=$(grep -oP 'https://.*?.trycloudflare.com' cloudflare.log | head -1)
            HOST=$(echo $TUNNEL_URL | sed 's|https://||' | sed 's|/.*||')
            
            echo "=========================================="
            echo "ANDROID EMULATOR READY"
            echo "=========================================="
            echo "Root: ENABLED"
            echo "RAM: 4GB"
            echo ""
            echo "Cloudflare Tunnel URL:"
            echo "$TUNNEL_URL"
            echo ""
            echo "Connect with:"
            echo "scrcpy --tcpip=$HOST:443 -b2M -m1024"
            echo "=========================================="
            
            for i in {1..21600}; do
              adb shell "date" > /dev/null 2>&1
              sleep 1
            done
